# 정의할 워크 플로우의 이름
name: Dojangkok Client CI/CD V2

# OIDC 인증을 위한 권한 설정
permissions:
  id-token: write # OIDC 토큰 발급에 필요
  contents: read # 소스코드 체크아웃에 필요

# 워크플로우를 실행할 이벤트 결정 및 매핑
on:
  push:
    branches: [dev]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    branches: [dev]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  workflow_dispatch:

# 실행할 작업을 정의
jobs:
  test: # 테스트를 수행하는 단계
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [22.x]
    steps:
      # 1. 소스코드를 체크아웃
      - name: Checkout repository
        uses: actions/checkout@v6
      # 2. Node.js 환경 설정
      - name: Set up Node.js runtime
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      # 3. 프로젝트의 의존성 패키지들을 설치
      - name: Install Dependencies
        run: npm ci --ignore-scripts
      # 4. Formatting 체크
      - name: Check Formatting
        run: npx prettier --check .
      # 4. Lint
      - name: Run Lint
        run: npm run lint
      # 5. 프로젝트의 테스트를 실행
      - name: Run tests
        run: npm run test:run || true

  build-and-push-image: # 빌드 및 Docker Image Push를 수행하는 단계
    needs: test
    runs-on: ubuntu-24.04-arm # arm64 runner를 사용
    strategy:
      matrix:
        node-version: [22.x]
    steps:
      # 1. 소스코드를 체크아웃
      - name: Checkout repository
        uses: actions/checkout@v6
      # 2. Docker Buildx 설정
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      # 3. AWS 자격증명 설정 (OIDC)
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}
      # 4. AWS ECR 로그인
      - name: Login to AWS ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      # 5. S3에서 .env 파일 다운로드
      - name: Download .env from S3
        run: aws s3 cp s3://${{ secrets.S3_BUCKET_NAME }}/frontend/v2/dev/.env ./.env
      # 6. env 파일을 읽어서 GitHub 환경 변수로 등록 (build-args로 넘기기 위함)
      - name: Load .env to GitHub Env
        run: cat .env >> $GITHUB_ENV
      # 7. infra/dev 디렉토리의 Docker 관련 파일을 프로젝트 root로 복사 (.dockerignore 적용을 위해)
      - name: Copy Docker files
        run: |
          cp infra/dev/Dockerfile ./
          cp infra/dev/.dockerignore ./
      # 8. 이미지 빌드 및 ECR로 Push
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          push: true
          provenance: false # 불필요한 메타데이터 파일 생성을 막음
          # 주요 설정값 주입
          build-args: |
            NEXT_PUBLIC_APP_URL=${{ env.NEXT_PUBLIC_APP_URL }}
            NEXT_PUBLIC_API_URL=${{ env.NEXT_PUBLIC_API_URL }}
          # 7-1. 배포 자동화에 사용하는 버전 (신규 push에 덮어써짐)
          # 7-2. 이력을 관리하기 위한 목적 (롤백용)
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/dev-dojangkok-fe:latest
            ${{ steps.login-ecr.outputs.registry }}/dev-dojangkok-fe:${{ github.sha }}
          # 빌드 성능 향상을 위한 캐시 설정
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy: # 배포를 수행하는 단계
    needs: build-and-push-image
    runs-on: ubuntu-latest
    steps:
      # 1. 소스코드를 체크아웃
      - name: Checkout repository
        uses: actions/checkout@v6
      # 2. AWS 자격증명 설정 (OIDC)
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}
      # 3. S3에서 .env 파일 다운로드
      - name: Download .env from S3
        run: aws s3 cp s3://${{ secrets.S3_BUCKET_NAME }}/frontend/v2/dev/.env ./.env
      # 4. Code Deploy에 전달할 artifact 구성
      - name: Make Zip File for CodeDeploy
        run: |
          cp infra/dev/docker-compose.yml ./
          cp infra/dev/deploy.sh ./
          cp infra/dev/appspec.yml ./
          chmod +x deploy.sh
          zip -r deploy.zip docker-compose.yml appspec.yml deploy.sh .env
      # 5. 구성한 artifact S3에 업로드
      - name: Upload Artifact to S3
        run: aws s3 cp deploy.zip s3://${{ secrets.S3_BUCKET_NAME }}/frontend/v2/dev/deploy.zip
      # 6. CodeDeploy 트리거 (GitHub 대신 S3를 보라고 명시)
      - name: Trigger CodeDeploy
        run: |
          DEPLOYMENT_ID=$(aws deploy create-deployment \
            --application-name dev-dojangkok-v2-fe \
            --deployment-group-name dev-dojangkok-v2-fe-dg \
            --deployment-config-name CodeDeployDefault.AllAtOnce \
            --s3-location bucket=${{ secrets.S3_BUCKET_NAME }},key=frontend/v2/dev/deploy.zip,bundleType=zip \
            --query "deploymentId" \
            --output text)

          echo "배포가 시작되었습니다. Deployment ID: $DEPLOYMENT_ID"
          echo "DEPLOYMENT_ID=$DEPLOYMENT_ID" >> $GITHUB_ENV
      # 7. Code Deploy 배포 완료 대기
      - name: Wait for Deployment Success
        run: |
          echo "CodeDeploy 배포 진행 중..."
          aws deploy wait deployment-successful --deployment-id ${{ env.DEPLOYMENT_ID }}
      # 8. 배포 후 Health Check
      - name: Health Check
        env:
          SERVICE_URL: ${{ secrets.SERVICE_URL }}
        run: |
          echo "Health Check 시작..."
          MAX_RETRIES=10
          RETRY_INTERVAL=5
          for i in $(seq 1 $MAX_RETRIES); do
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$SERVICE_URL/health-check" || echo "000")
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "Health Check 성공 (HTTP $HTTP_STATUS)"
              exit 0
            fi
            echo "시도 $i/$MAX_RETRIES: HTTP $HTTP_STATUS - ${RETRY_INTERVAL}초 후 재시도..."
            sleep $RETRY_INTERVAL
          done
          echo "Health Check 실패: 서비스가 응답하지 않습니다."
          exit 1
